name: Refresh ATLAS Data

# Runs 4x daily on weekdays, timed around market hours (ET = UTC-5 in winter, UTC-4 in summer):
#   8:15 AM (13:15 UTC) — pre-market:  overnight EDGAR filings, fresh data before open
#  11:30 AM (16:30 UTC) — mid-morning: morning filings captured, mid-session snapshot
#   3:00 PM (20:00 UTC) — pre-close:   afternoon filings, last snapshot before close
#   4:30 PM (21:30 UTC) — post-close:  all same-day filings + FRED VIX/10yr updates after close
#
# DST note (EDT = UTC-4, clocks spring forward in March):
#   Runs shift 1hr earlier in summer — still useful market-hour brackets.
#
# QuiverQuant free tier is 100 req/day — 4 calls/day leaves 96 to spare.
#
# GitHub Secrets required (Repo → Settings → Secrets → Actions → New repository secret):
#   QUIVER_KEY   — QuiverQuant API token  (quiverquant.com/quiverapi)
#   FRED_KEY     — FRED API key           (fred.stlouisfed.org/docs/api/api_key.html)
#   FINNHUB_KEY  — Finnhub API key        (finnhub.io)

on:
  schedule:
    - cron: '15 13 * * 1-5'   #  8:15 AM ET  Mon–Fri  (13:15 UTC) — pre-market
    - cron: '30 16 * * 1-5'   # 11:30 AM ET  Mon–Fri  (16:30 UTC) — mid-morning
    - cron: '0 20 * * 1-5'    #  3:00 PM ET  Mon–Fri  (20:00 UTC) — pre-close
    - cron: '30 21 * * 1-5'   #  4:30 PM ET  Mon–Fri  (21:30 UTC) — post-close
  workflow_dispatch:            # manual trigger from GitHub Actions tab

jobs:
  fetch:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # needed to commit updated JSON files back to repo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Run data fetcher
        env:
          QUIVER_KEY:  ${{ secrets.QUIVER_KEY }}
          FRED_KEY:    ${{ secrets.FRED_KEY }}
          FINNHUB_KEY: ${{ secrets.FINNHUB_KEY }}
        run: python3 scripts/fetch_data.py

      - name: Commit updated data files
        run: |
          git config --global user.name  'ATLAS Data Bot'
          git config --global user.email 'bot@atlasiq.io'
          git add data/
          # Only commit if something actually changed — skips empty runs
          git diff --staged --quiet || git commit -m "chore: refresh data $(date -u '+%Y-%m-%d %H:%M UTC') [skip ci]"
          git push

      - name: Notify on failure
        if: failure()
        run: |
          curl -s -d "ATLAS data fetch failed: ${{ github.workflow }} at $(date -u)" \
            https://ntfy.sh/atlas-${{ secrets.NTFY_CHANNEL }} || true
