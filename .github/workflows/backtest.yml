name: Brain Pipeline â€” Score & Deploy

# Runs Mon-Fri after data refresh completes
# Daily: ingest + enrich + score + export
# Monday: + full feature analysis + ML walk-forward
on:
  schedule:
    - cron: '0 22 * * 1-5'  # Mon-Fri 10:00 PM UTC (5:00 PM ET)
  workflow_dispatch:          # manual trigger

jobs:
  brain:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to commit brain export files

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install yfinance pandas numpy requests scikit-learn lightgbm scipy

      - name: Run daily pipeline (ingest + enrich + score + export)
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FRED_KEY: ${{ secrets.FRED_KEY }}
        run: python -m backtest.learning_engine --daily

      - name: Run weekly analysis (Mondays + manual triggers)
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FRED_KEY: ${{ secrets.FRED_KEY }}
        run: |
          DAY=$(date -u +%u)
          if [ "$DAY" = "1" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Running full analysis..."
            python -m backtest.learning_engine --analyze
          else
            echo "Skipping analysis (not Monday, not manual)"
          fi

      - name: Print summary
        run: python -m backtest.learning_engine --summary

      - name: Commit brain export files
        run: |
          git config --global user.name  'ATLAS Brain Bot'
          git config --global user.email 'bot@atlasiq.io'
          git add data/brain_signals.json data/brain_stats.json
          git diff --staged --quiet || git commit -m "chore(brain): update scores $(date -u '+%Y-%m-%d %H:%M UTC') [skip ci]"
          git push
